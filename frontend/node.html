<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Node | Akara的前端笔记</title>
    <meta name="generator" content="VuePress 1.7.0">
    <link rel="icon" href="/blog/favicon.ico">
    <meta name="description" content="Fooly Cooly">
    
    <link rel="preload" href="/blog/assets/css/0.styles.e57ea1a4.css" as="style"><link rel="preload" href="/blog/assets/js/app.8456fffd.js" as="script"><link rel="preload" href="/blog/assets/js/2.8618d6ad.js" as="script"><link rel="preload" href="/blog/assets/js/30.ab15011f.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.3ff23fab.js"><link rel="prefetch" href="/blog/assets/js/11.09b35f14.js"><link rel="prefetch" href="/blog/assets/js/12.a5230948.js"><link rel="prefetch" href="/blog/assets/js/13.da084bb4.js"><link rel="prefetch" href="/blog/assets/js/14.73ecbf39.js"><link rel="prefetch" href="/blog/assets/js/15.094f6105.js"><link rel="prefetch" href="/blog/assets/js/16.d882b772.js"><link rel="prefetch" href="/blog/assets/js/17.f99a3402.js"><link rel="prefetch" href="/blog/assets/js/18.efb4f04e.js"><link rel="prefetch" href="/blog/assets/js/19.07110711.js"><link rel="prefetch" href="/blog/assets/js/20.328904f9.js"><link rel="prefetch" href="/blog/assets/js/21.8cbdc7e9.js"><link rel="prefetch" href="/blog/assets/js/22.d2057d2a.js"><link rel="prefetch" href="/blog/assets/js/23.9f56128f.js"><link rel="prefetch" href="/blog/assets/js/24.b6b30cbb.js"><link rel="prefetch" href="/blog/assets/js/25.54438b61.js"><link rel="prefetch" href="/blog/assets/js/26.37498cf1.js"><link rel="prefetch" href="/blog/assets/js/27.2b58fbd4.js"><link rel="prefetch" href="/blog/assets/js/28.6c08951d.js"><link rel="prefetch" href="/blog/assets/js/29.e0f75c79.js"><link rel="prefetch" href="/blog/assets/js/3.b9f752a5.js"><link rel="prefetch" href="/blog/assets/js/31.8cf1b6d0.js"><link rel="prefetch" href="/blog/assets/js/32.73cca382.js"><link rel="prefetch" href="/blog/assets/js/33.2a56a474.js"><link rel="prefetch" href="/blog/assets/js/34.42cb3d03.js"><link rel="prefetch" href="/blog/assets/js/35.94137746.js"><link rel="prefetch" href="/blog/assets/js/36.e851453a.js"><link rel="prefetch" href="/blog/assets/js/37.dfcaa02b.js"><link rel="prefetch" href="/blog/assets/js/38.773d62c5.js"><link rel="prefetch" href="/blog/assets/js/39.fff934a2.js"><link rel="prefetch" href="/blog/assets/js/4.5a189e09.js"><link rel="prefetch" href="/blog/assets/js/40.d1f5a698.js"><link rel="prefetch" href="/blog/assets/js/41.de3b1ae8.js"><link rel="prefetch" href="/blog/assets/js/42.3ad3f220.js"><link rel="prefetch" href="/blog/assets/js/43.4b9dc29e.js"><link rel="prefetch" href="/blog/assets/js/44.bb8ac6d0.js"><link rel="prefetch" href="/blog/assets/js/45.3de7dbda.js"><link rel="prefetch" href="/blog/assets/js/46.6e6c0e4f.js"><link rel="prefetch" href="/blog/assets/js/47.1c9bfac2.js"><link rel="prefetch" href="/blog/assets/js/48.484b889d.js"><link rel="prefetch" href="/blog/assets/js/49.b9d5c97f.js"><link rel="prefetch" href="/blog/assets/js/5.f2578a9e.js"><link rel="prefetch" href="/blog/assets/js/50.805af6ea.js"><link rel="prefetch" href="/blog/assets/js/51.e4b8b0bf.js"><link rel="prefetch" href="/blog/assets/js/52.88f0f15b.js"><link rel="prefetch" href="/blog/assets/js/53.dc5a22fc.js"><link rel="prefetch" href="/blog/assets/js/54.589407ad.js"><link rel="prefetch" href="/blog/assets/js/55.534c1c0e.js"><link rel="prefetch" href="/blog/assets/js/56.7e25d242.js"><link rel="prefetch" href="/blog/assets/js/57.4c00257c.js"><link rel="prefetch" href="/blog/assets/js/58.2846c49a.js"><link rel="prefetch" href="/blog/assets/js/59.5cdc41e2.js"><link rel="prefetch" href="/blog/assets/js/6.b035c77d.js"><link rel="prefetch" href="/blog/assets/js/60.69050108.js"><link rel="prefetch" href="/blog/assets/js/7.e580f382.js"><link rel="prefetch" href="/blog/assets/js/8.db5c9552.js"><link rel="prefetch" href="/blog/assets/js/9.d0e88da4.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.e57ea1a4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">Akara的前端笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/frontend/" class="nav-link router-link-active">
  前端博客
</a></div><div class="nav-item"><a href="/blog/mianshi/" class="nav-link">
  面经
</a></div><div class="nav-item"><a href="/blog/gossip/" class="nav-link">
  杂记
</a></div> <a href="https://github.com/messiahhh/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/frontend/" class="nav-link router-link-active">
  前端博客
</a></div><div class="nav-item"><a href="/blog/mianshi/" class="nav-link">
  面经
</a></div><div class="nav-item"><a href="/blog/gossip/" class="nav-link">
  杂记
</a></div> <a href="https://github.com/messiahhh/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/blog/frontend/" aria-current="page" class="sidebar-link">HTML</a></li><li><a href="/blog/frontend/css.html" class="sidebar-link">CSS</a></li><li><a href="/blog/frontend/javascript.html" class="sidebar-link">JavaScript</a></li><li><a href="/blog/frontend/node.html" aria-current="page" class="active sidebar-link">Node</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#模块化" class="sidebar-link">模块化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#立即执行函数" class="sidebar-link" style="padding-left:4rem;">立即执行函数</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#amd" class="sidebar-link" style="padding-left:4rem;">AMD</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#commonjs" class="sidebar-link" style="padding-left:4rem;">CommonJS</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#umd" class="sidebar-link" style="padding-left:4rem;">UMD</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#es6模块" class="sidebar-link" style="padding-left:4rem;">ES6模块</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#pakeage-json" class="sidebar-link">pakeage.json</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#bin" class="sidebar-link" style="padding-left:4rem;">bin</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#script" class="sidebar-link" style="padding-left:4rem;">script</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#dependencies" class="sidebar-link" style="padding-left:4rem;">dependencies</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#devdependencies" class="sidebar-link" style="padding-left:4rem;">devDependencies</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#type" class="sidebar-link" style="padding-left:4rem;">type</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#files" class="sidebar-link" style="padding-left:4rem;">files</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#main" class="sidebar-link" style="padding-left:4rem;">main</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#browser-module" class="sidebar-link" style="padding-left:4rem;">browser | module</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#exports" class="sidebar-link" style="padding-left:4rem;">exports</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#package-lock-json" class="sidebar-link">package-lock.json</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#npm" class="sidebar-link">NPM</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#node-modules" class="sidebar-link" style="padding-left:4rem;">node_modules</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#npx" class="sidebar-link" style="padding-left:4rem;">npx</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#npm-ci" class="sidebar-link" style="padding-left:4rem;">npm ci</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#模块发布" class="sidebar-link" style="padding-left:4rem;">模块发布</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#事件循环" class="sidebar-link">事件循环</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#nexttick" class="sidebar-link" style="padding-left:4rem;">nextTick</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#node事件循环" class="sidebar-link" style="padding-left:4rem;">Node事件循环</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#http模块" class="sidebar-link">http模块</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#静态目录" class="sidebar-link" style="padding-left:4rem;">静态目录</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#处理post请求" class="sidebar-link" style="padding-left:4rem;">处理Post请求</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#fs模块" class="sidebar-link">fs模块</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#readfile" class="sidebar-link" style="padding-left:4rem;">readFile</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#writefile" class="sidebar-link" style="padding-left:4rem;">writeFile</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#createreadstream" class="sidebar-link" style="padding-left:4rem;">createReadStream</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#createwritestream" class="sidebar-link" style="padding-left:4rem;">createWriteStream</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#path模块" class="sidebar-link">path模块</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#dirname" class="sidebar-link" style="padding-left:4rem;">__dirname</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#path-resolve" class="sidebar-link" style="padding-left:4rem;">path.resolve</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#path-join" class="sidebar-link" style="padding-left:4rem;">path.join</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#process模块" class="sidebar-link">process模块</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#process-cwd" class="sidebar-link" style="padding-left:4rem;">process.cwd()</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#process-argv" class="sidebar-link" style="padding-left:4rem;">process.argv</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#process-stdout" class="sidebar-link" style="padding-left:4rem;">process.stdout</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#process-stdin" class="sidebar-link" style="padding-left:4rem;">process.stdin</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#环境变量" class="sidebar-link">环境变量</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#process-env" class="sidebar-link" style="padding-left:4rem;">process.env</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#cross-env" class="sidebar-link" style="padding-left:4rem;">cross-env</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#dotenv" class="sidebar-link" style="padding-left:4rem;">dotenv</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#util模块" class="sidebar-link">util模块</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#deprecate" class="sidebar-link" style="padding-left:4rem;">deprecate</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#promisify" class="sidebar-link" style="padding-left:4rem;">promisify</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#child-process模块" class="sidebar-link">child_process模块</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#fork" class="sidebar-link" style="padding-left:4rem;">fork</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#exec" class="sidebar-link" style="padding-left:4rem;">exec</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#execfile" class="sidebar-link" style="padding-left:4rem;">execFile</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#spawn" class="sidebar-link" style="padding-left:4rem;">spawn</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#cluster模块" class="sidebar-link">cluster模块</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#url模块" class="sidebar-link">url模块</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#querystring模块" class="sidebar-link">querystring模块</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#os模块" class="sidebar-link">os模块</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#event模块" class="sidebar-link">event模块</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#bluebird库" class="sidebar-link">bluebird库</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#bluebird-fs" class="sidebar-link" style="padding-left:4rem;">bluebird + fs</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#bluebird-mysql" class="sidebar-link" style="padding-left:4rem;">bluebird + mysql</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#pm2" class="sidebar-link">PM2</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#常用命令" class="sidebar-link" style="padding-left:4rem;">常用命令</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#命令行工具" class="sidebar-link">命令行工具</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#chalk" class="sidebar-link" style="padding-left:4rem;">chalk</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#yargs" class="sidebar-link" style="padding-left:4rem;">yargs</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#commander" class="sidebar-link" style="padding-left:4rem;">commander</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#inquirer" class="sidebar-link" style="padding-left:4rem;">inquirer</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#readline" class="sidebar-link" style="padding-left:4rem;">readline</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#puppeteer" class="sidebar-link">puppeteer</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#koa" class="sidebar-link">Koa</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#基础" class="sidebar-link" style="padding-left:4rem;">基础</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#koa-router" class="sidebar-link" style="padding-left:4rem;">koa-router</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#koa-static" class="sidebar-link" style="padding-left:4rem;">koa-static</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#koa-body" class="sidebar-link" style="padding-left:4rem;">koa-body</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#koa-logger" class="sidebar-link" style="padding-left:4rem;">koa-logger</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#koa-views" class="sidebar-link" style="padding-left:4rem;">koa-views</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#nestjs" class="sidebar-link">NestJS</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#controller" class="sidebar-link" style="padding-left:4rem;">Controller</a></li><li class="sidebar-sub-header"><a href="/blog/frontend/node.html#service" class="sidebar-link" style="padding-left:4rem;">Service</a></li></ul></li></ul></li><li><a href="/blog/frontend/stream.html" class="sidebar-link">流与二进制</a></li><li><a href="/blog/frontend/react.html" class="sidebar-link">React</a></li><li><a href="/blog/frontend/react相关库.html" class="sidebar-link">React相关库</a></li><li><a href="/blog/frontend/vue.html" class="sidebar-link">Vue</a></li><li><a href="/blog/frontend/react-vs-vue.html" class="sidebar-link">React-vs-Vue</a></li><li><a href="/blog/frontend/typescript.html" class="sidebar-link">TypeScript</a></li><li><a href="/blog/frontend/typescript-in-react.html" class="sidebar-link">TypeScript-In-React</a></li><li><a href="/blog/frontend/browser.html" class="sidebar-link">浏览器相关</a></li><li><a href="/blog/frontend/前端工程化.html" class="sidebar-link">前端工程化</a></li><li><a href="/blog/frontend/计算机网络.html" class="sidebar-link">计算机网络</a></li><li><a href="/blog/frontend/前端安全.html" class="sidebar-link">前端安全</a></li><li><a href="/blog/frontend/错误监控.html" class="sidebar-link">错误监控</a></li><li><a href="/blog/frontend/网站优化.html" class="sidebar-link">性能优化</a></li><li><a href="/blog/frontend/数据结构.html" class="sidebar-link">数据结构</a></li><li><a href="/blog/frontend/排序.html" class="sidebar-link">排序算法</a></li><li><a href="/blog/frontend/编程题.html" class="sidebar-link">编程题</a></li><li><a href="/blog/frontend/mongodb.html" class="sidebar-link">MongoDB</a></li><li><a href="/blog/frontend/mysql.html" class="sidebar-link">Mysql</a></li><li><a href="/blog/frontend/linux.html" class="sidebar-link">Linux</a></li><li><a href="/blog/frontend/git.html" class="sidebar-link">Git</a></li><li><a href="/blog/frontend/docker.html" class="sidebar-link">Docker</a></li><li><a href="/blog/frontend/设计模式.html" class="sidebar-link">设计模式</a></li><li><a href="/blog/frontend/websocket.html" class="sidebar-link">WebSocket</a></li><li><a href="/blog/frontend/webgl.html" class="sidebar-link">Three.js</a></li><li><a href="/blog/frontend/php.html" class="sidebar-link">PHP</a></li><li><a href="/blog/frontend/代码段记录.html" class="sidebar-link">代码记录</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="node"><a href="#node" class="header-anchor">#</a> Node</h1> <h2 id="模块化"><a href="#模块化" class="header-anchor">#</a> 模块化</h2> <p><strong>在Node中引入模块，会发生什么？</strong></p> <p>在Node中，模块分为两类：一类是node提供的<strong>核心模块</strong>，一类是用户编写的<strong>文件模块</strong></p> <ul><li><p>路径分析</p> <p>如果发现引入的是核心模块，则不用进行接下来的两步了，因为核心模块早已编译为二进制，当node进程启动时，部分核心代码已经直接加载进内存中。</p></li> <li><p>文件定位</p></li> <li><p>编译执行</p></li></ul> <h5 id="立即执行函数"><a href="#立即执行函数" class="header-anchor">#</a> 立即执行函数</h5> <p>立即执行函数（IIFE）是以前主流的模块化方案，比如<code>Jquery</code>就使用该方案。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 定义模块</span>
<span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">window</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token constant">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">'aaa'</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token constant">B</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">'bbb'</span>
    <span class="token punctuation">}</span>

    window<span class="token punctuation">.</span>myModule <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token constant">A</span><span class="token punctuation">,</span> <span class="token constant">B</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span>

<span class="token comment">// 使用模块</span>
myModule<span class="token punctuation">.</span><span class="token constant">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h5 id="amd"><a href="#amd" class="header-anchor">#</a> AMD</h5> <p>很久以前的一种模块化方案，类似的方案还有CMD。需要额外安装<code>require.js</code>库，使用<code>define</code>定义模块，使用<code>require</code>加载模块。</p> <p>现在基本不用。</p> <h5 id="commonjs"><a href="#commonjs" class="header-anchor">#</a> CommonJS</h5> <p>最主流的模块化方案。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// a.js</span>
<span class="token keyword">function</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'Akara'</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> getName

<span class="token comment">// b.js</span>
<span class="token keyword">const</span> getName <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./a'</span><span class="token punctuation">)</span>
<span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 'Akara'</span>
</code></pre></div><p><code>require</code>可以简单看作包了一层立即执行函数，该立即执行函数返回了那个模块的<code>module.exports</code></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> getName <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./a'</span><span class="token punctuation">)</span>
<span class="token comment">// 等价于</span>
<span class="token keyword">const</span> getName <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">'Akara'</span>
    <span class="token punctuation">}</span>

    module<span class="token punctuation">.</span>exports <span class="token operator">=</span> getName

    <span class="token comment">// 返回module.exports</span>
    <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>模块内部有<code>module</code>和<code>exports</code>两个变量，其中<code>module.exports</code>和<code>exports</code>指向同一片内存。</p> <p>又因为我们模块实际返回的是<code>module.exports</code>，所以如果直接对<code>exports</code>变量重新赋值肯定是错误的操作。</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token operator">:</span> <span class="token punctuation">{</span>
    id<span class="token operator">:</span> <span class="token string">'.'</span>
	exports<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="umd"><a href="#umd" class="header-anchor">#</a> UMD</h5> <p><code>UMD</code>是上述三种模块化方案<code>IIFE</code>、<code>AMD</code>、<code>CommonJS</code>的结合，即用来兼容多套模块化系统。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> factory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> define <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> define<span class="token punctuation">.</span>amd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果支持AMD模块化</span>
        <span class="token function">define</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> module <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果支持CommonJS模块化</span>
        module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">factory</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果以上两种都不支持，设置全局变量来保存模块内容</span>
        root<span class="token punctuation">.</span>returnExports <span class="token operator">=</span> <span class="token function">factory</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 模块的业务代码放在这</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h5 id="es6模块"><a href="#es6模块" class="header-anchor">#</a> ES6模块</h5> <p>ES6模块使用<code>import</code>和<code>export</code>来导入和导出模块。</p> <p>新版本Node已经支持<code>node app.mjs</code>的写法，老版本Node需要开启<code>--experimental-modules</code>使用该特性。</p> <p>除了通过文件后缀名来区分<code>ES</code>模块，我们也可以设置<code>package.json</code>的<code>type</code>字段为<code>module</code>来表示这是一个<code>ES</code>模块，此时文件可以是<code>.js</code>后缀。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// a.js</span>
<span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token string">'aka'</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> name <span class="token comment">// 等价于 export { name as default }</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 等价于 export { getName as getName }</span>
    <span class="token keyword">return</span> name
<span class="token punctuation">}</span>

<span class="token comment">// b.js</span>
<span class="token keyword">import</span> name <span class="token keyword">from</span> <span class="token string">'./a.js'</span> <span class="token comment">// 等价于 import { default as name }</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> getName <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./a.js'</span> <span class="token comment">// 等价于 import { getName as getName }</span>
</code></pre></div><p>我们也可以自行定义模块接口的名字</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// a.js</span>
<span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token string">'aka'</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span> name <span class="token keyword">as</span> alias <span class="token punctuation">}</span>

<span class="token comment">// b.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> alias <span class="token keyword">as</span> myName <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./a.js'</span>
</code></pre></div><p>我们还可以使用<code>import * as xx from</code>的写法来加载整个模块。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// a.js</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token string">'aka'</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> age <span class="token operator">=</span> <span class="token number">20</span>

<span class="token comment">// b.js</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> m <span class="token keyword">from</span> <span class="token string">'./a.js'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>
<span class="token comment">// Module {</span>
<span class="token comment">//   age: 20</span>
<span class="token comment">//   name: &quot;aka&quot;</span>
<span class="token comment">//   Symbol(Symbol.toStringTag): &quot;Module&quot;</span>
<span class="token comment">//   __esModule: true</span>
<span class="token comment">// }</span>
</code></pre></div><p>事实上，在<code>ES</code>模块中我们可以加载<code>CommonJS</code>模块。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// a.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'common模块'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// b.mjs</span>
<span class="token keyword">import</span> a <span class="token keyword">from</span> <span class="token string">'./a.js'</span> <span class="token comment">// 默认导入了a.js文件的module.exports</span>
<span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h6 id="对比"><a href="#对比" class="header-anchor">#</a> 对比</h6> <p><code>CJS</code>模块和<code>MJS</code>模块存在几大区别</p> <ol><li><p><code>CJS</code>模块不存在默认导出<code>default</code>，<code>MJS</code>模块存在<code>default</code>。</p></li> <li><p><code>CJS</code>模块会被整体导入，而<code>MJS</code>可以被部分导入。因此使用<code>MJS</code>可以<code>tree shaking</code>。</p></li> <li><p><code>import</code>命令会在<strong>其他所有代码执行前</strong>就被JavaScript引擎静态分析，可以说它是在<strong>编译时加载模块</strong>。</p> <p>所以我们通常只能把<code>import</code>放在模块的顶层，并且不能放在如<code>if</code>之类的代码块中。</p> <p>并且由于这个特性，我们不能在JS代码执行中根据条件来动态加载模块，而<code>require</code>可以做到这一点，<code>require</code>是<strong>运行时加载模块</strong>。</p> <p>好在，我们可以使用<code>import()</code>来实现<strong>运行时加载模块</strong>，组件的懒加载通常就是使用<code>import()</code>搭配代码分割来实现的。</p></li></ol> <h2 id="pakeage-json"><a href="#pakeage-json" class="header-anchor">#</a> pakeage.json</h2> <h5 id="bin"><a href="#bin" class="header-anchor">#</a> bin</h5> <p>我们可以借助<code>bin</code>字段来开发命令行工具。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;myapp&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;bin&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;myapp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./cli.js&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code>#<span class="token operator">!</span><span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env node
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'aka'</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> i myapp 
npx myapp
</code></pre></div><p>当我们成功安装好一个模块，NPM会自动根据<code>package.json</code>的<code>bin</code>字段来添加对应的符号链接。我们从而可以使用<code>./node_module/.bin/myapp</code>或<code>npx myapp</code>，又或是<code>package.json</code>的<code>script</code>字段来直接执行脚本。</p> <p>如果我们需要本地开发一个命令行工具，那么在添加<code>bin</code>字段后需要自行使用<code>npm link</code>来创建符号链接。</p> <h5 id="script"><a href="#script" class="header-anchor">#</a> script</h5> <p><code>npm</code>除了<code>npm ci</code>、<code>npm install</code>等内置脚本，还包括<code>hook script</code>（<code>pre/post script）</code>和<code>lifecycle script</code>。</p> <h6 id="pre-post-script"><a href="#pre-post-script" class="header-anchor">#</a> pre/post script</h6> <p>对于一个脚本我们可能想要在其执行之前或之后执行某些操作，此时可以使用<code>pre</code>或<code>post</code>前缀。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;script&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;echo \&quot;i'm test\&quot;&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;pretest&quot;</span><span class="token operator">:</span> <span class="token string">&quot;echo \&quot;在test脚本执行前执行\&quot;&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;posttest&quot;</span><span class="token operator">:</span> <span class="token string">&quot;echo \&quot;在test脚本执行后执行\&quot;&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h6 id="lifecycle-script"><a href="#lifecycle-script" class="header-anchor">#</a> lifecycle script</h6> <p><code>npm</code>存在一些会在特定场景触发的脚本，比如<code>prepare</code>脚本会在执行<code>npm install</code>前执行。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;script&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;prepare&quot;</span><span class="token operator">:</span> <span class="token string">&quot;echo \&quot;hello akara\&quot;&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="dependencies"><a href="#dependencies" class="header-anchor">#</a> dependencies</h5> <p>项目的依赖。</p> <h5 id="devdependencies"><a href="#devdependencies" class="header-anchor">#</a> devDependencies</h5> <p>项目的开发依赖。如果我们在NPM发布了一个模块A，之后当我们<code>npm install A</code>时会自动安装模块A的依赖，但不会安装模块A的开发依赖。</p> <h5 id="type"><a href="#type" class="header-anchor">#</a> type</h5> <p><code>.cjs</code>文件会被视为<code>CommonJS</code>模块，<code>.mjs</code>会被视为<code>es</code>模块，<code>.js</code>则会根据<code>package.json</code>的<code>type</code>字段视为不同的模块。</p> <p>默认情况<code>package.json</code>不包括<code>type</code>字段，<code>.js</code>文件被视为<code>CommonJS</code>模块，我们能够使用<code>require</code>而不能使用<code>import</code>。</p> <p>当我们加上<code>type: module</code>，则<code>.js</code>文件会被视为<code>es</code>模块，我们能够使用<code>import</code>语法。</p> <h5 id="files"><a href="#files" class="header-anchor">#</a> files</h5> <p><code>files</code>字段用来规定模块的哪些文件能够被外部下载引入，默认值为<code>[*]</code>，即模块的所有文件都能被外部下载引用。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// my-module/public/test.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'我是模块的内部文件'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// app.js</span>
<span class="token keyword">const</span> test <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'my-module/public/test'</span><span class="token punctuation">)</span>
<span class="token keyword">import</span> <span class="token string">'antd/dist/antd.css'</span>
</code></pre></div><p>我们能够通过修改<code>files</code>字段来限制模块能够被下载的文件，不过需要注意的是以下文件永远都会被外部下载：<code>package.json</code>、<code>README</code>、<code>CHANGE / CHANGELOG / HISTORY</code>、<code>LICENSE / LICENCE</code>、<code>NOTICE</code>、<code>main</code>字段指向的文件。</p> <h5 id="main"><a href="#main" class="header-anchor">#</a> main</h5> <p>用来规定模块的默认入口，默认值为<code>index.js</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> test <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'my-module'</span><span class="token punctuation">)</span> <span class="token comment">// 引入my-module模块的根目录的index.js文件</span>
</code></pre></div><h5 id="browser-module"><a href="#browser-module" class="header-anchor">#</a> browser | module</h5> <p>一般<code>browser</code>字段指向<code>cjs</code>或<code>umd</code>模块，<code>module</code>字段指向<code>es</code>模块，大多数情况下这两个字段都没什么用处。</p> <p>在某些情况下，特别是使用<code>webpack</code>打包模块时，当<code>webpack</code>配置的<code>target</code>为<code>web</code>（默认值），会根据模块的<code>browser</code>字段导入模块；通过设置<code>target</code>为<code>node</code>，会根据<code>module</code>字段导入模块。</p> <p>另外，当<code>package.json</code>不存在对应的入口字段，会根据<code>browser -&gt; module -&gt; main</code>的优先级导入模块。这个优先级是根据配置<code>resolve.mainFields</code>字段指定的，我们可以通过修改该字段来调整优先级：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// webpack.config.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    target<span class="token operator">:</span> <span class="token string">'node'</span><span class="token punctuation">,</span> <span class="token comment">// 默认值web</span>
    resolve<span class="token operator">:</span> <span class="token punctuation">{</span>
        mainFields<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'main'</span><span class="token punctuation">,</span> <span class="token string">'module'</span><span class="token punctuation">,</span> <span class="token string">'browser'</span><span class="token punctuation">]</span> <span class="token comment">// 默认值 ['browser', 'module', 'main']</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="exports"><a href="#exports" class="header-anchor">#</a> exports</h5> <p><code>exports</code>字段在功能上和<code>main</code>相近，使用起来更加灵活。如果同时存在<code>exports</code>和<code>main</code>，<code>exports</code>的优先级更高。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;exports&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;.&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./index.js&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 需要加上./</span>
        <span class="token property">&quot;./test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./src/test.js&quot;</span> 
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> test <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'my-module'</span><span class="token punctuation">)</span> <span class="token comment">// ./index.js</span>
<span class="token keyword">const</span> test2 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'my-module/test'</span><span class="token punctuation">)</span> <span class="token comment">// ./src/test.js</span>
</code></pre></div><p>需要特别注意的是，使用<code>exports</code>字段时，<code>files</code>字段的作用就会失效。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> test <span class="token keyword">from</span> <span class="token string">'my-module/main.js'</span> <span class="token comment">// 报错</span>
</code></pre></div><p><code>exports</code>最大的特性是能够根据导入模块时使用的是<code>require</code>还是<code>import</code>选择不同的导出。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;exports&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;.&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;require&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./a.js&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;import&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./b.mjs&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="package-lock-json"><a href="#package-lock-json" class="header-anchor">#</a> package-lock.json</h2> <p>在<code>package.json</code>的<code>dependencies</code>字段中我们经常能看见这种形式的版本号<code>&quot;react&quot;: &quot;^17.0.2&quot;</code>、<code>&quot;xx&quot;: &quot;~0.10.0&quot;</code>，这种写法通常被称为<a href="https://github.com/npm/node-semver" target="_blank" rel="noopener noreferrer"><code>semver</code>表示法<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，三个数字分别表示主要版本、次要版本、补丁版本。</p> <p>当我们<code>clone</code>项目后使用<code>npm install</code>来安装依赖，或者是在已有的项目中使用<code>npm update</code>来更新依赖，都会根据<code>semver</code>规则安装对应版本的模块，也就是说<strong>实际安装版本并不是固定的</strong>。</p> <ul><li><p><code>^</code>：表示只会执行不更改最左边非零数字的更新。比如<code>^0.10.0</code>，意味着我们可以安装（或更新，下同）<code>0.10.1</code>等版本，但不能安装<code>0.11.0</code>或更高的版本；又比如<code>^1.10.0</code>，意味着我们可以安装<code>1.10.1</code>、<code>1.11.0</code>等版本，但不能安装<code>2.0.0</code>或更高的版本。</p></li> <li><p><code>~</code>：如果我在比较器中指定了次要版本，那么只允许补丁版本的更新；如果没有指定次要版本，那么可以允许次要版本的更新，所以通常情况<code>~</code>只允许补丁级别的更新。比如<code>~1.10.0</code>的依赖，意味着我们只能安装<code>1.10.x</code>的版本，不能安装<code>1.11.0</code>的版本。</p></li></ul> <p>使用<code>semver</code>表示法，<strong>不锁版本的好处</strong>是当我们项目所依赖的某个模块存在漏洞时，该模块的开发者可以发布一个补丁级别的新版本，而我们开发者可以直接<code>npm update</code>来更新所有模块。</p> <p>而<strong>不锁版本的坏处是</strong>，当项目所依赖的某个模块偷偷地更新了小版本，对我们来说是无感知的。一旦这个依赖的更新引入了一些破坏性变更，那么当我们<code>clone</code>项目并<code>npm install</code>后可能发现项目跑不起来（特别是使用CI进行构建的时候）</p> <p>针对这样的问题，<code>yarn</code>和新版的<code>npm</code>都默认启用了<code>lock</code>机制，当我们<code>npm i</code>的时候会生成<code>package-lock.json</code>文件<strong>固定依赖的版本号</strong>，今后每次修改<code>package.json</code>依赖的时候（如<code>npm i xx@latest</code>），<code>package-lock.json</code>也会相应的改变，这两个文件的<strong>依赖强关联</strong>。</p> <p>当项目中存在<code>package-lock.json</code>时，我们通过<code>npm i</code>或<code>npm update</code>安装的都是指定版本的模块。</p> <hr> <p>不过很明显锁不锁版本都有对应的好处和坏处，所以社区对是否锁版本还存在着一些<a href="https://www.zhihu.com/question/65536076" target="_blank" rel="noopener noreferrer">争论<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>另外，无论是否使用<code>lock</code>机制，都不应该把<code>package-lock.json</code>写入<code>.gitignore</code>中。</p> <p>如果我们使用<code>lock</code>机制，应该直接把<code>package-lock.json</code>提交进仓库；如果我们不使用<code>lock</code>机制，则应该在<code>.npmrc</code>中写入<code>package-lock=false</code>来关闭<code>lock</code>机制，并把<code>package-lock.json</code>提交到仓库中。<a href="https://www.zhihu.com/question/264560841" target="_blank" rel="noopener noreferrer">参考<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="npm"><a href="#npm" class="header-anchor">#</a> NPM</h2> <h5 id="node-modules"><a href="#node-modules" class="header-anchor">#</a> node_modules</h5> <p>在<code>NPM</code>的早期版本，<code>node_modules</code>使用嵌套结构来管理模块之间的依赖关系。而我们的很多模块都又可能依赖于同一个模块，这样的结构可能导致性能的浪费。</p> <div class="language- extra-class"><pre class="language-text"><code>- A -&gt; B
- C -&gt; B
</code></pre></div><p>所以在<code>NPM@3.x</code>以后，<code>node_modules</code>主要使用扁平结构来管理模块之间的依赖关系。假设我们安装了A和C模块，这两个模块同时依赖于同一个版本的B模块，此时<code>node_modules</code>结构如下。</p> <div class="language- extra-class"><pre class="language-text"><code>- A
- C
- B
</code></pre></div><p>不过有的时候，我们安装的模块A和C可能依赖于同一个模块B的不同版本。</p> <ol><li><p>假设<code>node_modules</code>存在<code>B@1.1.0</code>。然后我们安装的模块A依赖于<code>B@^1.1.0</code>，即使模块B最新版本已经到了<code>1.9.0</code>，我们也会复用原本已安装的模块。</p> <div class="language- extra-class"><pre class="language-text"><code>- A
- B@1.1.0
</code></pre></div></li> <li><p>假设<code>node_modules</code>存在<code>B@1.1.0</code>。然后我们安装的模块A依赖于<code>B@^1.2.0</code>，则会安装最新的模块（如<code>B@1.9.0</code>）</p> <div class="language- extra-class"><pre class="language-text"><code>- A -&gt; B@1.9.0 
- B@1.1.0
</code></pre></div></li></ol> <h5 id="npx"><a href="#npx" class="header-anchor">#</a> npx</h5> <p>在<code>npx@5.2</code>之后引入了<code>npx</code>这个强大的命令。</p> <p>除了提供了像<code>npx pm2</code>这样的脚本执行方式，<code>npx</code>的另一个特性是无需安装即可执行命令。</p> <p>比如<code>npx create-react-app my-app</code>，我们无需提前安装<code>create-react-app</code>，借助<code>npx</code>会下载并使用该库来生成我们的项目，并在任务执行完成后删除下载好的<code>create-react-app</code>。</p> <h5 id="npm-ci"><a href="#npm-ci" class="header-anchor">#</a> npm ci</h5> <p><code>npm ci</code>的作用和<code>npm i</code>一样，用来安装依赖模块，而该命令经常被用在持续集成CI当中。</p> <p>使用该命令时需要确保项目中存在<code>package-lock.json</code>或<code>npm-shrinkwrap.json</code>，并且当<code>package.json</code>和<code>package-lock.json</code>中依赖的版本不一致时<code>npm ci</code>会抛出错误。</p> <h5 id="模块发布"><a href="#模块发布" class="header-anchor">#</a> 模块发布</h5> <p>在使用<code>npm login</code>登陆自己的NPM账号之后，我们可以在项目目录使用<code>npm publish</code>发布模块，使用<code>npm unpublish --force</code>来删除发布的模块，需要注意的是NPM的镜像源需要是官方镜像<code>npm config set registry https://registry.npmjs.org</code></p> <p>NPM的模块分为公共模块和私有模块，发布私有模块是需要付费的。除此之外NPM的模块还存在形如<code>@akara/my-package</code>这样子的，属于用户作用域的模块，如果想要发布这样的模块，首先需要确保模块的名字形如<code>@akara/my-package</code>，并且由于这种模块默认是私有的，为了不花钱我们需要使用<code>npm publish --access public</code>来发布公共的作用域模块。</p> <p>当我们发布一个npm库时，通常目的是发布构建后的文件，所以我们需要控制哪些文件可以被发布，哪些文件不会被发布。</p> <ol><li><code>.gitignore</code>中的文件不会被发布</li> <li><code>.npmignore</code>中的文件不会被发布</li> <li><code>package.json</code>中的<code>files</code>字段指定哪些文件会被发布</li></ol> <h2 id="事件循环"><a href="#事件循环" class="header-anchor">#</a> 事件循环</h2> <p>浏览器和Node环境都存在事件循环这一概念，但因为它们基于不同的架构所以实现原理也有些许不同，比如浏览器环境的事件循环是通过主线程和工作线程之间的调度实现的。另外，在Node的<code>11.0</code>版本的发布之后，同一段代码在两个不同环境的表现也越来越相似了，所以在这里我会主要以浏览器环境介绍事件循环的原理。</p> <p>众所周知浏览器是基于多线程的，除了用来渲染页面的GUI渲染线程，还有执行JavaScript代码的主线程和各种工作线程，不同的工作线程分别用来处理定时器任务、I/O操作、事件等操作。</p> <p>当我们在主线程执行一段代码时，通常会使用<code>fetch</code>来发出一个请求，发请求的这个操作是交给专门的工作线程来执行的，因此该操作本身并不会阻塞后续代码的执行。而当我们收到了对应的响应时，该工作线程会把一个<strong>任务</strong>交给主线程执行，这就是所谓的<strong>异步</strong>。</p> <p>当然了，此时我们的主线程可能还在执行代码中，所以实际上任务并不会立刻被交给主线程执行，与之对应的是该任务会被添加进一个专门的<strong>任务队列</strong>当中，主线程执行完代码后会从任务队列中取出任务来执行。不仅如此，根据不同的类型我们又把任务分为<strong>宏任务</strong>和<strong>微任务</strong>，因此我们的队列也有两个：<strong>宏任务队列</strong>和<strong>微任务队列</strong>。</p> <p>那么先让我们明确哪些任务属于宏任务和微任务，首先我们可以把最初交给主线程执行的代码视为一个宏任务，其他的宏任务包括：<code>setTimeout</code>或<code>setInterval</code>、<code>I/O</code>操作（如<code>ajax</code>或文件读取）、事件（如点击事件）、<code>setImmediate</code>（Node专有）。而最常见的微任务有<code>promise.then()</code>。</p> <p>事件循环的基本规则就是，执行完一个宏任务，再执行微任务队列中的所有微任务，再执行下一个宏任务...如此往复。因此一个事件循环可以视为一个宏任务+所有微任务，另外也可以把执行一个宏任务的阶段，或着执行所有微任务的阶段，称作一个<code>tick</code>，由此可见一个事件循环由两个<code>tick</code>组成。无论是对于Node中的<code>process.nextTick</code>还是<code>Vue</code>中的<code>$.nextTick</code>，理解何为<code>tick</code>都是很有帮助的。</p> <h5 id="nexttick"><a href="#nexttick" class="header-anchor">#</a> nextTick</h5> <p><code>process.nextTick</code>是Node独有的一个方法，顾名思义我们可以知道这个方法的目的是让某个任务在下一个<code>tick</code>的最开始执行。比如，当我们处在一个宏任务阶段调用<code>process.nextTick</code>，那么会在当前宏任务执行结束后，在后续的微任务阶段执行前执行<code>nextTick</code>接受的回调函数。</p> <p>事实上在Node中专门维护了一个<code>nextTick</code>队列，每当我们执行完一个<code>tick</code>，就会执行<code>nextTick</code>队列中的所有任务（行为很像微任务队列）。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 可以想一想这个代码的结果</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
    process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>
    process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h5 id="node事件循环"><a href="#node事件循环" class="header-anchor">#</a> Node事件循环</h5> <p>Node的架构和浏览器有很大不同，因此它实现事件循环的方式也大相径庭。Node的事件循环中有<strong>六个阶段</strong>，<strong>每个阶段中都有一个宏队列，总共只有一个微队列和一个<code>nextTick</code>队列</strong>。</p> <ol><li><code>Timer</code>: <code>SetTimeout</code>和<code>SetInterval</code>的回调放进该阶段的任务队列。</li> <li><code>pending callback</code>: 执行一些系统操作的回调，例如TCP的错误。</li> <li><code>idle, prepare</code>: 处理一些内部调用。</li> <li><code>poll</code>: <strong>大部分其他回调会被仿佛该阶段的任务队列</strong></li> <li><code>check</code>: <code>SetImmediate</code>的回调放进该阶段的任务队列。</li> <li><code>close callback</code>: 一些结束时的回调，例如<code>Socket.on(&quot;close&quot;)</code></li></ol> <p>我们可以只重点关注三个阶段，<code>Timer</code>、<code>poll</code>、<code>check</code>。</p> <p>低版本（<code>v11.0</code>以前）的Node表现的行为和浏览器环境有很大的不同，是因为低版本下的Node在执行完<strong>一个阶段的所有宏任务</strong>再执行微任务；而<strong>高版本的Node表现和浏览器一致</strong>，即执行完一个宏任务再执行微任务。</p> <p>以下的这段代码在不同版本的Node下表现的行为就会有所不同</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span>
process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ol><li>当我们遇到<code>setImmediate</code>后，将其回调函数放进<code>check</code>阶段的宏队列中。</li> <li>当我们遇到<code>process.nextTick</code>后，将其回调函数放进<code>nextTick</code>队列中。因为此时同步代码（或者说最初的宏任务）执行完毕，那么执行<code>nextTick</code>队列中的任务。</li> <li><strong>输出2</strong>， 遇到<code>setImmediate</code>后，将其回调函数放进<code>check</code>阶段的宏队列中。</li> <li>开始执行<code>check</code>队列中的宏任务。</li> <li>执行<code>check</code>第一个宏任务，<strong>输出1</strong>，将<code>nextTick</code>的回调放进队列里。</li></ol> <p>以上五步，无论版本如何都是一致的，接下来就是高低版本Node的不同。</p> <p><strong>低版本Node</strong></p> <p>因为低版本Node是执<strong>行完一个阶段中的全部宏任务后，再执行微队列的全部任务</strong>。所以<strong>先输出3，再输出4。</strong></p> <p><strong>高版本Node</strong></p> <p>因为高版本Node是<strong>执行完一个宏任务，就执行微队列的全部任务</strong>。所以<strong>先输出4，再输出3。</strong></p> <h2 id="http模块"><a href="#http模块" class="header-anchor">#</a> http模块</h2> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">)</span> <span class="token comment">// 请求url</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>method<span class="token punctuation">)</span> <span class="token comment">// 请求方法</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">)</span> <span class="token comment">// 请求头部</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 设置响应的状态码和头部</span>
        res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'text/plain; charset=utf-8'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token comment">// 单独设置状态码</span>
        res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">200</span>
        <span class="token comment">// 单独设置响应头部</span>
        res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/plain; charset=utf-8'</span><span class="token punctuation">)</span>
        <span class="token comment">// Set-Cookie</span>
        res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Set-Cookie'</span><span class="token punctuation">,</span> <span class="token string">'name=akara; secure'</span><span class="token punctuation">)</span>
		
        <span class="token comment">// 设置响应实体</span>
        res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;hello world&quot;</span><span class="token punctuation">)</span>
        res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;!!!&quot;</span><span class="token punctuation">)</span>
        <span class="token comment">// 发送响应报文</span>
        res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;服务器跑在3000端口&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h5 id="静态目录"><a href="#静态目录" class="header-anchor">#</a> 静态目录</h5> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> filePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'static'</span><span class="token punctuation">,</span> url<span class="token punctuation">.</span>pathname<span class="token punctuation">)</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> file <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">readFileAsync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span>
            res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">200</span>
            res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">404</span>
            res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&quot;404 Not Found&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 或者</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> fileName <span class="token operator">=</span> url<span class="token punctuation">.</span>pathname
        <span class="token keyword">let</span> type
        <span class="token keyword">switch</span><span class="token punctuation">(</span>fileName<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span>fileName<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token string">'css'</span><span class="token operator">:</span>
                type <span class="token operator">=</span> <span class="token string">'text/css; charset=utf-8'</span>
                <span class="token keyword">break</span>
            <span class="token keyword">case</span> <span class="token string">'js'</span><span class="token operator">:</span>
                type <span class="token operator">=</span> <span class="token string">'applaction/javascript; charset=utf-8'</span>
                <span class="token keyword">break</span>
            <span class="token comment">// other situations </span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                type <span class="token operator">=</span> <span class="token string">'application/octet-stream'</span>
                <span class="token keyword">break</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> file <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">readFileAsync</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./static</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token punctuation">.</span>pathname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
            res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'Content-Type'</span><span class="token operator">:</span> type<span class="token punctuation">}</span><span class="token punctuation">)</span>
            res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'text/plain; charset=utf-8'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&quot;404错误啦！&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>


</code></pre></div><h5 id="处理post请求"><a href="#处理post请求" class="header-anchor">#</a> 处理Post请求</h5> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 前端 (省略部分代码)</span>
<span class="token keyword">let</span> type <span class="token operator">=</span> <span class="token keyword">typeof</span> data
<span class="token keyword">let</span> header
<span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    header <span class="token operator">=</span> <span class="token string">'application/x-www-form-urlencoded'</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token keyword">instanceof</span> <span class="token class-name">File</span> <span class="token operator">||</span> data <span class="token keyword">instanceof</span> <span class="token class-name">FormData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    header <span class="token operator">=</span> <span class="token string">'multipart/form-data; boundary=---xxxxxxxxxxxx'</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token punctuation">{</span>
    header <span class="token operator">=</span> <span class="token string">'application/json'</span>
    data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">'Content-type'</span><span class="token punctuation">,</span> header<span class="token punctuation">)</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>


<span class="token comment">// 后端</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">'/upload'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">let</span> segment <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

        req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// chunk为Buffer对象</span>
            <span class="token comment">// 字符串aaa=bbb对应的Buffer对象如下</span>
            <span class="token comment">// &lt;Buffer 61 61 61 3d 62 62 62&gt;</span>
            segment<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 文件上传代码</span>
            segment <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>segment<span class="token punctuation">)</span>
            <span class="token comment">// 下方代码获取buffer转成的字符串</span>
            <span class="token comment">// segment = Buffer.concat(segment).toString()</span>
            fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span><span class="token string">'fileName'</span><span class="token punctuation">,</span> segment<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'text/plain; charset=utf-8'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
                res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;文件上传成功！&quot;</span><span class="token punctuation">)</span>
                res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;服务器跑在3000端口&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="fs模块"><a href="#fs模块" class="header-anchor">#</a> fs模块</h2> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
</code></pre></div><h5 id="readfile"><a href="#readfile" class="header-anchor">#</a> <code>readFile</code></h5> <div class="language-javascript extra-class"><pre class="language-javascript"><code>fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'./image.png'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> buffer</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h5 id="writefile"><a href="#writefile" class="header-anchor">#</a> <code>writeFile</code></h5> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 写入文本</span>
fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span><span class="token string">'index.txt'</span><span class="token punctuation">,</span> <span class="token string">'hello world'</span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span>
<span class="token comment">// 写入buffer</span>
fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span><span class="token string">'image.png'</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span>
</code></pre></div><h5 id="createreadstream"><a href="#createreadstream" class="header-anchor">#</a> <code>createReadStream</code></h5> <h5 id="createwritestream"><a href="#createwritestream" class="header-anchor">#</a> <code>createWriteStream</code></h5> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> reader <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>path<span class="token punctuation">)</span>
<span class="token keyword">const</span> stream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./image/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.jpg</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
reader<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span>
</code></pre></div><h2 id="path模块"><a href="#path模块" class="header-anchor">#</a> path模块</h2> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
</code></pre></div><h5 id="dirname"><a href="#dirname" class="header-anchor">#</a> <code>__dirname</code></h5> <p>返回当前文件所在的<strong>绝对路径</strong></p> <h5 id="path-resolve"><a href="#path-resolve" class="header-anchor">#</a> <code>path.resolve</code></h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> url <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'static'</span><span class="token punctuation">)</span>
</code></pre></div><p>根据传入的参数解析出对应的<strong>绝对路径</strong>。</p> <ul><li><p>当传入的参数是相对路径，如<code>index</code>、<code>../index</code>，会算出相对**<code>process.cwd()</code>**的绝对路径</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> url <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span> <span class="token comment">// 等于process.cwd()</span>
</code></pre></div></li> <li><p>当传入的参数是绝对路径，如<code>/index</code>，会算出相对<strong>根路径</strong>的绝对路径</p></li></ul> <h5 id="path-join"><a href="#path-join" class="header-anchor">#</a> <code>path.join</code></h5> <p>用来拼接传入的参数得到一个<strong>相对路径</strong>，它的好处是可以抹平不同平台的分割符号的差异（如Linux环境下分隔符为<code>/</code>，而Windows环境下分隔符为<code>\</code>）</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> path1 <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">)</span> <span class="token comment">// 'a/b'</span>
<span class="token keyword">const</span> path2 <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'../c'</span><span class="token punctuation">)</span> <span class="token comment">// 'a/c'</span>
<span class="token keyword">const</span> path3 <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'..'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">)</span> 
</code></pre></div><h2 id="process模块"><a href="#process模块" class="header-anchor">#</a> process模块</h2> <h5 id="process-cwd"><a href="#process-cwd" class="header-anchor">#</a> <code>process.cwd()</code></h5> <p>获得执行脚本时所处的绝对路径。当我们使用<code>fs.readFile</code>等函数并传入<code>./index.html</code>形式的相对路径时，相对路径实际上是相对于执行脚本时所在的目录路径，也就是相对于<code>process.cwd()</code>。</p> <p>因此根据执行脚本时所处路径的不同，结果也可能有很大的差异，所以很多时候我们会传入绝对路径，如</p> <div class="language-js extra-class"><pre class="language-js"><code>fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>__dirname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/../index.html</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../index.html'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h5 id="process-argv"><a href="#process-argv" class="header-anchor">#</a> <code>process.argv</code></h5> <p>获取执行脚本时命令行输入的参数</p> <div class="language-js extra-class"><pre class="language-js"><code>$node index<span class="token punctuation">.</span>js abc
<span class="token punctuation">[</span>
    <span class="token string">'node'</span><span class="token punctuation">,</span>
    <span class="token string">'index.js'</span><span class="token punctuation">,</span>
    <span class="token string">'abc'</span>
<span class="token punctuation">]</span> <span class="token comment">// process.argv</span>
</code></pre></div><h5 id="process-stdout"><a href="#process-stdout" class="header-anchor">#</a> <code>process.stdout</code></h5> <p>标准输出流</p> <div class="language-js extra-class"><pre class="language-js"><code>process<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'Hello world'</span><span class="token punctuation">)</span>
</code></pre></div><h5 id="process-stdin"><a href="#process-stdin" class="header-anchor">#</a> <code>process.stdin</code></h5> <p>标准输入流</p> <div class="language-js extra-class"><pre class="language-js"><code>process<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    process<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'Hello'</span> <span class="token operator">+</span> chunk<span class="token punctuation">)</span>
    process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="环境变量"><a href="#环境变量" class="header-anchor">#</a> 环境变量</h2> <h5 id="process-env"><a href="#process-env" class="header-anchor">#</a> <code>process.env</code></h5> <p>在<code>Node</code>中可以通过<code>process.env</code>拿到环境变量，从而根据不同的环境执行不同的代码。</p> <h5 id="cross-env"><a href="#cross-env" class="header-anchor">#</a> cross-env</h5> <p>通常不同系统设置环境变量的方式不同，为此可以使用第三方库<code>cross-env</code>来设置环境变量。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// package.json</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;script&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cross-env NODE_ENV=development node app.js&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="dotenv"><a href="#dotenv" class="header-anchor">#</a> dotenv</h5> <p>除了在命令行中设置环境变量，我们也可以使用单独的文件<code>.env</code>来保存环境变量，并搭配<code>dotenv</code>库来读取<code>.env</code>文件中的环境变量。</p> <div class="language-.env extra-class"><pre class="language-text"><code>NODE_ENV=development
name=aka
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app.js</span>
<span class="token keyword">const</span> dotenv <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'dotenv'</span><span class="token punctuation">)</span>
dotenv<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 读取.env文件中的信息</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span><span class="token punctuation">)</span>
</code></pre></div><p>或者我们可以写一个<code>config.js</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// config.js</span>
<span class="token keyword">const</span> dotenv <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'dotenv'</span><span class="token punctuation">)</span>
dotenv<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token constant">NODE_ENV</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>name
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">NODE_ENV</span><span class="token punctuation">,</span> name <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./config.js'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">NODE_ENV</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
</code></pre></div><h2 id="util模块"><a href="#util模块" class="header-anchor">#</a> util模块</h2> <p>这个模块提供了诸多很有用的小工具。</p> <h5 id="deprecate"><a href="#deprecate" class="header-anchor">#</a> <code>deprecate</code></h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> util <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span>
<span class="token keyword">function</span> <span class="token constant">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'aaa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">deprecate</span><span class="token punctuation">(</span><span class="token constant">A</span><span class="token punctuation">,</span> <span class="token string">'A() is deprecated. Use B() instead.'</span><span class="token punctuation">)</span>
</code></pre></div><h5 id="promisify"><a href="#promisify" class="header-anchor">#</a> <code>promisify</code></h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> util <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> readFile <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">promisify</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span>readFile<span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token constant">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'./index.html'</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><h2 id="child-process模块"><a href="#child-process模块" class="header-anchor">#</a> child_process模块</h2> <p>Node的<code>child_process</code>模块提供了创建子进程的四种方式，分别是<code>folk</code>、<code>exec</code>、<code>execFile</code>、<code>spawn</code>。</p> <p>其中，只有<code>fork</code>是用来创建Node程序的子进程，其他三种可以用来创建<code>shell</code>子进程。</p> <h5 id="fork"><a href="#fork" class="header-anchor">#</a> <code>fork</code></h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// parent.js</span>
<span class="token keyword">const</span> cp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> child <span class="token operator">=</span> cp<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token string">'./child.js'</span><span class="token punctuation">)</span>

child<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 进程通信</span>
  	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  	child<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
child<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span>

<span class="token comment">// child.js</span>
process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  	process<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'akara'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><code>exec</code>可以直接在Node代码中写入<code>shell</code>命令，并且在执行一些危险的脚本（如<code>rm / -rf</code>）是不会提示的；而<code>execFile</code>和<code>spawn</code>的参数都是文件的名字，并且<code>execFile</code>在执行危险操作时会爆出异常，因此更加的安全。</p> <h5 id="exec"><a href="#exec" class="header-anchor">#</a> <code>exec</code></h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> exec <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">promisify</span><span class="token punctuation">(</span>cp<span class="token punctuation">.</span>exec<span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">exec</span><span class="token punctuation">(</span>cat $<span class="token punctuation">{</span>file<span class="token punctuation">}</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h5 id="execfile"><a href="#execfile" class="header-anchor">#</a> <code>execFile</code></h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> exec <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">promisify</span><span class="token punctuation">(</span>cp<span class="token punctuation">.</span>execFile<span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	<span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">'cat'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>file<span class="token punctuation">]</span><span class="token punctuation">)</span>
  	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h5 id="spawn"><a href="#spawn" class="header-anchor">#</a> <code>spawn</code></h5> <p><code>spawn</code>的特点是基于流的，因此可以使用<code>pipe</code>显得更加灵活</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> cat <span class="token operator">=</span> cp<span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token string">'cat'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>file<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> sort <span class="token operator">=</span> cp<span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token string">'sort'</span><span class="token punctuation">)</span>

cat<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>sort<span class="token punctuation">.</span>stdin<span class="token punctuation">)</span>
sort<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span>
</code></pre></div><h2 id="cluster模块"><a href="#cluster模块" class="header-anchor">#</a> cluster模块</h2> <p>使用cluster来搭建集群node应用</p> <p>怎么讲呢，直接看网上的代码吧。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> cluster <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cluster'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> numCPUs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token comment">// 获取CPU的个数</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>cluster<span class="token punctuation">.</span>isMaster<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numCPUs<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cluster<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

  cluster<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'exit'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">worker<span class="token punctuation">,</span> code<span class="token punctuation">,</span> signal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'worker '</span> <span class="token operator">+</span> worker<span class="token punctuation">.</span>process<span class="token punctuation">.</span>pid <span class="token operator">+</span> <span class="token string">' died'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&quot;hello world\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>以上代码，父进程根据CPU的数量创建子进程。只看代码的话，容易理解成每一个进程都创建了一个server来监听8000端口，但这是不切实际的。其实cluster做了很多事情，在实际的情况下，父进程会创建server监听端口，收到的请求会分发给不同的进程去处理。</p> <p>cluster让我们不用亲自去管理进程通信的事情（process.on('message')），而且也自带负载均衡的策略。</p> <p>默认情况，除了windows系统下，使用cluster时的负载均衡策略为round-robin。比如刚才的服务器，收到了8个请求，第一个请求交给第一个子进程处理，第二个请求交给第二个子进程...</p> <p>在windows系统下，通过以下代码来设置负载均衡策略为round-robin</p> <p><code>cluster.schedulingPolicy = cluster.SCHED_RR;</code></p> <p>另外，pm2也自带cluster，比如可以靠以下代码创建8个子进程。</p> <p><code>pm2 start app.js -i 8</code></p> <h2 id="url模块"><a href="#url模块" class="header-anchor">#</a> url模块</h2> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 当请求url为 http://localhost:3000/index.html?name=akara#aa</span>
<span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'url'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> <span class="token punctuation">{</span>
    search<span class="token punctuation">,</span> <span class="token comment">// '?name=akara'</span>
    query<span class="token punctuation">,</span> <span class="token comment">// 'name=akara'</span>
    pathname<span class="token punctuation">,</span> <span class="token comment">// '/index.html'</span>
    path<span class="token punctuation">,</span> <span class="token comment">// '/index.html?name=akara'</span>
<span class="token punctuation">}</span> <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
</code></pre></div><h2 id="querystring模块"><a href="#querystring模块" class="header-anchor">#</a> querystring模块</h2> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'querystring'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> str <span class="token operator">=</span> <span class="token string">'foo=bar&amp;abc=xyz&amp;abc=123'</span><span class="token punctuation">;</span>

querystring<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>
<span class="token comment">// { foo: 'bar', abc: [ 'xyz', '123' ] }</span>
</code></pre></div><h2 id="os模块"><a href="#os模块" class="header-anchor">#</a> os模块</h2> <p>获取操作系统相关信息。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> os <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> homedir <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">homedir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 获取用户目录</span>
</code></pre></div><h2 id="event模块"><a href="#event模块" class="header-anchor">#</a> event模块</h2> <blockquote><p>实现原理见本文的设计模式-发布订阅章节</p></blockquote> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> EventEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>EventEmitter
<span class="token keyword">var</span> emitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

emitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'ev'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>

emitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'ev'</span><span class="token punctuation">)</span>
</code></pre></div><hr> <p>以上是Node自带的核心库，下面介绍一些常用的第三方库。</p> <h2 id="bluebird库"><a href="#bluebird库" class="header-anchor">#</a> bluebird库</h2> <p>可以将回调函数实现的异步改写成Promise的方式来写的第三方库。</p> <h5 id="bluebird-fs"><a href="#bluebird-fs" class="header-anchor">#</a> bluebird + fs</h5> <p>回调</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>Promise</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> bluebird <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'bluebird'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> bluebird<span class="token punctuation">.</span><span class="token function">promisifyAll</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

fs<span class="token punctuation">.</span><span class="token function">readFileAsync</span><span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h5 id="bluebird-mysql"><a href="#bluebird-mysql" class="header-anchor">#</a> bluebird + mysql</h5> <p>回调</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> mysql <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mysql'</span><span class="token punctuation">)</span>
<span class="token comment">// mysql配置文件</span>
<span class="token keyword">let</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./config'</span><span class="token punctuation">)</span>
conn<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 使用</span>
conn<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">sql code here...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>Promise</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> bluebird <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'bluebird'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> mysql <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mysql'</span><span class="token punctuation">)</span>
<span class="token comment">// mysql配置文件</span>
<span class="token keyword">let</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./config'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> conn <span class="token operator">=</span> bluebird<span class="token punctuation">.</span><span class="token function">promisifyAll</span><span class="token punctuation">(</span>mysql<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span>
conn<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 使用</span>
<span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token keyword">await</span> conn<span class="token punctuation">.</span><span class="token function">queryAsync</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">sql code here...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
</code></pre></div><h2 id="pm2"><a href="#pm2" class="header-anchor">#</a> PM2</h2> <p>除了常见的<code>pm2 start index.js</code>，我们也可以使用配置文件。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 比如取名为 ecosystem.config.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  apps<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
    script<span class="token operator">:</span> <span class="token string">'./server/app.js'</span><span class="token punctuation">,</span>
    watch<span class="token operator">:</span> <span class="token string">'.'</span><span class="token punctuation">,</span>
    env_development<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;REACT_APP_NODE_ENV&quot;</span><span class="token operator">:</span> <span class="token string">&quot;development&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    env_production<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;REACT_APP_NODE_ENV&quot;</span><span class="token operator">:</span> <span class="token string">&quot;production&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>之后通过以下命令来启动服务</p> <div class="language-shell extra-class"><pre class="language-shell"><code>pm2 start ecosystem.config.js --env development
// or
pm2 start ecosystem.config.js --env production
</code></pre></div><h5 id="常用命令"><a href="#常用命令" class="header-anchor">#</a> 常用命令</h5> <div class="language-js extra-class"><pre class="language-js"><code>pm2 start app<span class="token punctuation">.</span>js
pm2 list
pm2 <span class="token keyword">delete</span> <span class="token punctuation">[</span>app<span class="token operator">-</span>id<span class="token punctuation">]</span>
pm2 logs
pm2 logs <span class="token punctuation">[</span>app<span class="token operator">-</span>name<span class="token punctuation">]</span>
pm2 monit
<span class="token comment">// ...</span>
</code></pre></div><h2 id="命令行工具"><a href="#命令行工具" class="header-anchor">#</a> 命令行工具</h2> <p>介绍常用的命令行工具</p> <h5 id="chalk"><a href="#chalk" class="header-anchor">#</a> chalk</h5> <p>给日志输出加上颜色。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> chalk <span class="token keyword">from</span> <span class="token string">'chalk'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">blue</span><span class="token punctuation">(</span><span class="token string">'akara'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// 蓝色字体</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span>blue<span class="token punctuation">.</span><span class="token function">bgRed</span><span class="token punctuation">(</span><span class="token string">'akara'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 蓝色字体，红色背景</span>
</code></pre></div><h5 id="yargs"><a href="#yargs" class="header-anchor">#</a> yargs</h5> <p>提供了对命令行参数的解析功能，并且默认提供了<code>--help</code>、<code>--version</code>选项。</p> <div class="language-js extra-class"><pre class="language-js"><code>#<span class="token operator">!</span><span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env node
<span class="token keyword">const</span> yargs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;yargs/yargs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> hideBin <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;yargs/helpers&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;http&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">yargs</span><span class="token punctuation">(</span><span class="token function">hideBin</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// hideBin(process.argv) 相当于 process.argv.slice(2)</span>
    <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span> 
        <span class="token string">&quot;serve [port]&quot;</span><span class="token punctuation">,</span> <span class="token comment">// [port]为可选参数</span>
        <span class="token string">&quot;启动服务器&quot;</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token comment">// 设置命令参数的别名、默认值等信息</span>
            port<span class="token operator">:</span> <span class="token punctuation">{</span>
                alias<span class="token operator">:</span> <span class="token string">&quot;p&quot;</span><span class="token punctuation">,</span>
                <span class="token keyword">default</span><span class="token operator">:</span> <span class="token number">3000</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token parameter">argv</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>argv<span class="token punctuation">.</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">服务器运行在</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>argv<span class="token punctuation">.</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">端口</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">&quot;curl &lt;url&gt;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;发送请求&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">argv</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// &lt;url&gt;为必须参数</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>argv<span class="token punctuation">.</span>verbose<span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'已经开启verbose'</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>argv<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">'verbose'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      alias<span class="token operator">:</span> <span class="token string">'v'</span><span class="token punctuation">,</span>
      type<span class="token operator">:</span> <span class="token string">'boolean'</span><span class="token punctuation">,</span>
      description<span class="token operator">:</span> <span class="token string">'Run with verbose logging'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>argv<span class="token punctuation">;</span>
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code>cli --help
cli --version
cli serve <span class="token number">8000</span> <span class="token comment"># cli serve -p 8000 | cli serve --port=8000</span>
cli <span class="token function">curl</span> <span class="token string">'google.com'</span> -v
</code></pre></div><h5 id="commander"><a href="#commander" class="header-anchor">#</a> commander</h5> <p>和<code>yargs</code>作用差不多，可以选择其中一个来开发自己的命令行工具。</p> <div class="language-js extra-class"><pre class="language-js"><code>#<span class="token operator">!</span><span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env node
<span class="token keyword">const</span> <span class="token punctuation">{</span> program <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'commander'</span><span class="token punctuation">)</span>

program
    <span class="token punctuation">.</span><span class="token function">version</span><span class="token punctuation">(</span><span class="token string">'1.0.0'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">'cli tool'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">'--verbose'</span><span class="token punctuation">,</span> <span class="token string">'use verbose'</span><span class="token punctuation">)</span> <span class="token comment">// 布尔值</span>
    <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">'-u, --url &lt;url&gt;'</span><span class="token punctuation">,</span> <span class="token string">'url参数'</span><span class="token punctuation">)</span> <span class="token comment">// 必须参数</span>
    <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">'-p, --port [port]'</span><span class="token punctuation">,</span> <span class="token string">'port参数'</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span> <span class="token comment">// 可选参数，可设置默认值</span>
    <span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>program<span class="token punctuation">.</span><span class="token function">opts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h5 id="inquirer"><a href="#inquirer" class="header-anchor">#</a> inquirer</h5> <p>非常有用的命令行工具，常见于各种脚手架中。</p> <div class="language-js extra-class"><pre class="language-js"><code>#<span class="token operator">!</span><span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env node
<span class="token keyword">const</span> inquirer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'inquirer'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> questions <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token string">'confirm'</span><span class="token punctuation">,</span>
        name<span class="token operator">:</span> <span class="token string">'isPeople'</span><span class="token punctuation">,</span>
        message<span class="token operator">:</span> <span class="token string">'你是人吗?'</span><span class="token punctuation">,</span>
        <span class="token keyword">default</span><span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token string">'input'</span><span class="token punctuation">,</span>
        name<span class="token operator">:</span> <span class="token string">'name'</span><span class="token punctuation">,</span>
        message<span class="token operator">:</span> <span class="token string">'请输入你的名字'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token string">'input'</span><span class="token punctuation">,</span>
        name<span class="token operator">:</span> <span class="token string">'phone'</span><span class="token punctuation">,</span>
        message<span class="token operator">:</span> <span class="token string">'请输入你的电话号码'</span><span class="token punctuation">,</span>
        <span class="token function">validate</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> pass <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^1[34578]\d{9}$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pass<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span>
            <span class="token keyword">return</span> <span class="token string">'请输入正确的电话号码'</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token string">'list'</span><span class="token punctuation">,</span>
        name<span class="token operator">:</span> <span class="token string">'sex'</span><span class="token punctuation">,</span>
        message<span class="token operator">:</span> <span class="token string">'请选择你的性别'</span><span class="token punctuation">,</span>
        choices<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'Male'</span><span class="token punctuation">,</span> <span class="token string">'Female'</span><span class="token punctuation">,</span> <span class="token string">'None'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> val<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
inquirer
    <span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span>questions<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">answers</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>answers<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h5 id="readline"><a href="#readline" class="header-anchor">#</a> readline</h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 官网代码</span>
<span class="token keyword">const</span> readline <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'readline'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> rl <span class="token operator">=</span> readline<span class="token punctuation">.</span><span class="token function">createInterface</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    input<span class="token operator">:</span> process<span class="token punctuation">.</span>stdin<span class="token punctuation">,</span>
    output<span class="token operator">:</span> process<span class="token punctuation">.</span>stdout
<span class="token punctuation">}</span><span class="token punctuation">)</span>

rl<span class="token punctuation">.</span><span class="token function">question</span><span class="token punctuation">(</span><span class="token string">'你好'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">answer</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'666'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rl<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 官网代码</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> readline <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'readline'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">processLineByLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> fileStream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">'log.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> rl <span class="token operator">=</span> readline<span class="token punctuation">.</span><span class="token function">createInterface</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    input<span class="token operator">:</span> fileStream<span class="token punctuation">,</span>
    crlfDelay<span class="token operator">:</span> <span class="token number">Infinity</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 注意：我们使用 crlfDelay 选项将 input.txt 中的所有 CR LF 实例（'\r\n'）识别为单个换行符。</span>

  <span class="token keyword">for</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">const</span> line <span class="token keyword">of</span> rl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// input.txt 中的每一行在这里将会被连续地用作 `line`。</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Line from file: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>line<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">processLineByLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="puppeteer"><a href="#puppeteer" class="header-anchor">#</a> puppeteer</h2> <p>使用<code>puppeteer.connect</code>来复用已启动的浏览器进程。</p> <ol><li><p>启动Chrome的时候加上<code>--remote-debugging-port=9222</code>，重启浏览器</p></li> <li><p>访问<code>http://127.0.0.1:9222/json/version</code>拿到<code>webSocketDebuggerUrl</code>字段</p></li> <li><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token string">'ws://127.0.0.1:9222/devtools/browser/81daad69-fb53-49ea-9f97-3683b73afea0'</span>
<span class="token keyword">const</span> browser <span class="token operator">=</span> <span class="token keyword">await</span> puppeteer<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    browserWSEndpoint<span class="token operator">:</span> url<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li></ol> <p>参考：https://medium.com/@jaredpotter1/connecting-puppeteer-to-existing-chrome-window-8a10828149e0</p> <h2 id="koa"><a href="#koa" class="header-anchor">#</a> Koa</h2> <h5 id="基础"><a href="#基础" class="header-anchor">#</a> 基础</h5> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> start <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> ms <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> - </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ms<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// response</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">200</span>
  ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'Content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/plain; charset=utf-8'</span><span class="token punctuation">)</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'Hello Koa'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 一些其他的方法</span>
ctx<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/home'</span><span class="token punctuation">)</span>
<span class="token comment">// 相当于</span>
<span class="token comment">// res.status = 302</span>
<span class="token comment">// res.setHeader('Location', '/home')</span>
</code></pre></div><h6 id="核心实现"><a href="#核心实现" class="header-anchor">#</a> 核心实现</h6> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> Emitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span>
<span class="token comment">// 三个对象，提前定义好原型的方法</span>
<span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./context'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> request <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./request'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./response'</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Koa</span> <span class="token keyword">extends</span> <span class="token class-name">Emitter</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>middleware <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>request <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>response <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>middleware<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handlerRequest</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> fn<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">use</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> fn <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'middleware must be a function!'</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>middleware<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span>

    <span class="token function">listen</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">createContext</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 其实就是根据已有的req和res创建上下文context</span>
        <span class="token keyword">const</span> context <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> request <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> response <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        context<span class="token punctuation">.</span>request <span class="token operator">=</span> request
        context<span class="token punctuation">.</span>response <span class="token operator">=</span> response
        context<span class="token punctuation">.</span>app <span class="token operator">=</span> request<span class="token punctuation">.</span>app <span class="token operator">=</span> response<span class="token punctuation">.</span>app <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token comment">// 重点，挂载req和res</span>
        context<span class="token punctuation">.</span>req <span class="token operator">=</span> request<span class="token punctuation">.</span>req <span class="token operator">=</span> response<span class="token punctuation">.</span>req <span class="token operator">=</span> req<span class="token punctuation">;</span>
        context<span class="token punctuation">.</span>res <span class="token operator">=</span> request<span class="token punctuation">.</span>res <span class="token operator">=</span> response<span class="token punctuation">.</span>res <span class="token operator">=</span> res<span class="token punctuation">;</span>
        <span class="token comment">// 互相引用</span>
        request<span class="token punctuation">.</span>ctx <span class="token operator">=</span> response<span class="token punctuation">.</span>ctx <span class="token operator">=</span> context<span class="token punctuation">;</span>
        request<span class="token punctuation">.</span>response <span class="token operator">=</span> response<span class="token punctuation">;</span>
        response<span class="token punctuation">.</span>request <span class="token operator">=</span> request<span class="token punctuation">;</span>
        <span class="token keyword">return</span> context
    <span class="token punctuation">}</span>

    <span class="token function">handlerRequest</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> res <span class="token operator">=</span> ctx<span class="token punctuation">.</span>res
        res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">404</span>
        <span class="token function">fn</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">reason</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Koa的实例app有三个公共的API</p> <ul><li><p>use</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>use方法用于将参数中间件放进app的middleware数组里</p></li> <li><p>listen</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>
</code></pre></div><p>等价于</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code> <span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p>callback</p> <p>该函数内部实现三个功能</p> <ol><li><p>使用koa-compose函数将middleware中间件数组转化为中间件fn</p></li> <li><p>调用app.createContext函数。创建context，request，response对象；将request和response挂载在context上；把req和res挂载在三个对象上。</p> <p>例如：request的原型对象上部分代码如下</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">get</span> <span class="token function">header</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token keyword">set</span> <span class="token function">header</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>req<span class="token punctuation">.</span>headers <span class="token operator">=</span> val<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>我们现在就可以根据<code>ctx.request.header</code>获取req的headers了</p></li> <li><p>执行handleRequest函数，本质是把组装好的context传入中间件fn执行</p></li></ol></li></ul> <p>Koa源码中使用到了Koa-compose， 用于将多个中间件函数组合为一个中间件函数</p> <h6 id="koa-compose"><a href="#koa-compose" class="header-anchor">#</a> koa-compose</h6> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">compose</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">middleware</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>middleware<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">&quot;Middleware stack must be an array!&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> fn <span class="token keyword">of</span> middleware<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> fn <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">&quot;Middleware must be composed of functions!&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> length <span class="token operator">=</span> middleware<span class="token punctuation">.</span>length
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
        <span class="token keyword">return</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">function</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 一个中间件内部多次调用next时，index大于等于i</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span> index <span class="token operator">&gt;=</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'next() called multiple times'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">let</span> fn
            index <span class="token operator">=</span> i
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                fn <span class="token operator">=</span> middleware<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">===</span> length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 重点， 外部compose的next传进内部compose</span>
                fn <span class="token operator">=</span> next
            <span class="token punctuation">}</span>
            <span class="token comment">// 最后一个中间件调用next时，什么也不做</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fn<span class="token punctuation">)</span> <span class="token keyword">return</span>
            <span class="token comment">// 官方源码使用Promise是为了使用async中间件，不过这里没有怎么实现这个功能，就一个样子</span>
            <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">fn</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token function">dispatch</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="koa-router"><a href="#koa-router" class="header-anchor">#</a> koa-router</h5> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-router'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
router
  <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'Hello World!'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/users'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'/users/:id'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span><span class="token string">'/users/:id'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token string">'/users/:id'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">allowedMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 此处例子没有实现该方法</span>
</code></pre></div><h6 id="简易实现"><a href="#简易实现" class="header-anchor">#</a> 简易实现</h6> <p>简易实现，只实现一个get方法，实际上要更复杂的多。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Router</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>stack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>

    <span class="token function">get</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">function</span> <span class="token function">middleware</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>req<span class="token punctuation">.</span>method<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'get'</span> <span class="token operator">&amp;&amp;</span> ctx<span class="token punctuation">.</span>req<span class="token punctuation">.</span>url <span class="token operator">===</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'路由匹配成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">fn</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'路由匹配失败'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>middleware<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span>

    <span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> fn <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>stack<span class="token punctuation">)</span>
            <span class="token comment">// 必须加上next参数</span>
            <span class="token comment">// koa本身有一个compose， 这里也有一个，所以要把外部的next传给内部</span>
            <span class="token function">fn</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="koa-static"><a href="#koa-static" class="header-anchor">#</a> koa-static</h5> <p>用于处理静态资源的koa中间件</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token keyword">static</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-static'</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">static</span><span class="token punctuation">(</span><span class="token string">'public'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h5 id="koa-body"><a href="#koa-body" class="header-anchor">#</a> koa-body</h5> <p>处理请求的中间件，可以轻松获得请求的内容</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> body <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-body'</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">{</span>multipart<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h5 id="koa-logger"><a href="#koa-logger" class="header-anchor">#</a> koa-logger</h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> logger <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-logger'</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h5 id="koa-views"><a href="#koa-views" class="header-anchor">#</a> koa-views</h5> <p>通常用于搭配模板引擎进行服务端渲染，不过似乎现在不怎么用了。</p> <p>另外使用的场合要额外去安装对应的模板引擎，比如想用<code>ejs</code>记得先<code>npm i ejs</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> views <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-views'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> render <span class="token operator">=</span> <span class="token function">views</span><span class="token punctuation">(</span><span class="token string">'./views'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> extension<span class="token operator">:</span> <span class="token string">'ejs'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>render<span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'template'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        content<span class="token operator">:</span> <span class="token string">'hello'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-ejs extra-class"><pre class="language-ejs"><code><span class="token comment">&lt;!-- template.ejs --&gt;</span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%=</span><span class="token language-javascript"> content </span><span class="token delimiter punctuation">%&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>    
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="nestjs"><a href="#nestjs" class="header-anchor">#</a> NestJS</h2> <p>NestJS是个使用装饰器模式（风格类似前端的Angular）的Node后端框架，同时对TypeScript支持良好。</p> <div class="language-js extra-class"><pre class="language-js"><code>npm i <span class="token operator">-</span>g @nestjs<span class="token operator">/</span>cli
nest <span class="token keyword">new</span> <span class="token class-name">my</span><span class="token operator">-</span>project
</code></pre></div><div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token comment">// main.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> NestFactory <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AppModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app.module'</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">await</span> NestFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>AppModule<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app.module.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AppController<span class="token punctuation">,</span> MyController <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app.controller'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AppService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app.service'</span><span class="token punctuation">;</span>

@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  controllers<span class="token operator">:</span> <span class="token punctuation">[</span>AppController<span class="token punctuation">,</span> MyController<span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>AppService<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><h5 id="controller"><a href="#controller" class="header-anchor">#</a> Controller</h5> <p>我们可以通过编写<code>controller</code>来实现后端路由。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app.controller.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Controller<span class="token punctuation">,</span> Get<span class="token punctuation">,</span> Post<span class="token punctuation">,</span> Req<span class="token punctuation">,</span> Res<span class="token punctuation">,</span> Body<span class="token punctuation">,</span> Param<span class="token punctuation">,</span> Query<span class="token punctuation">,</span> Headers<span class="token punctuation">,</span> Header<span class="token punctuation">,</span> HttpCode <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Request <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'express'</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">DTO</span> <span class="token punctuation">{</span> <span class="token comment">// 数据传输对象</span>
  value<span class="token operator">:</span> string
<span class="token punctuation">}</span>

@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppController</span> <span class="token punctuation">{</span>
  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 匹配/路径</span>
  <span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'hello'</span>
  <span class="token punctuation">}</span>

  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'admin'</span><span class="token punctuation">)</span> <span class="token comment">// 匹配/admin路径</span>
  <span class="token function">getAdmin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'admin'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token string">'/api'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">MyController</span> <span class="token punctuation">{</span>
  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'fetchAllInfo'</span><span class="token punctuation">)</span> <span class="token comment">// 匹配/api/fetchAllInfo</span>
  <span class="token function">fetchInfo</span><span class="token punctuation">(</span>@<span class="token function">Req</span><span class="token punctuation">(</span><span class="token punctuation">)</span> req<span class="token operator">:</span> Request<span class="token punctuation">,</span> @<span class="token function">Query</span><span class="token punctuation">(</span><span class="token punctuation">)</span> query<span class="token punctuation">)</span><span class="token operator">:</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token comment">// 拿到Req、Query</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>

  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/fetchOneInfo/:id'</span><span class="token punctuation">)</span>
  <span class="token function">fetchOneInfo</span><span class="token punctuation">(</span>@<span class="token function">Param</span><span class="token punctuation">(</span><span class="token punctuation">)</span> params<span class="token punctuation">,</span> @<span class="token function">Headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> headers<span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span> <span class="token comment">// 拿到Params、响应头Headers</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">'a'</span>
  <span class="token punctuation">}</span>

  @<span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">'/updateOneInfo/:id'</span><span class="token punctuation">)</span>
  <span class="token function">updateOneInfo</span><span class="token punctuation">(</span>@<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span> id<span class="token operator">:</span> number<span class="token punctuation">,</span> @<span class="token function">Body</span><span class="token punctuation">(</span><span class="token punctuation">)</span> body<span class="token operator">:</span> <span class="token constant">DTO</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 通过@Param('id')可以直接拿到具体的Param。拿到Body</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token comment">// 自动序列化为JSON并设置对应Content-Type</span>
      code<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
      msg<span class="token operator">:</span> <span class="token string">'success'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'html'</span><span class="token punctuation">)</span>
  @<span class="token function">Header</span><span class="token punctuation">(</span><span class="token string">'Cache-Control'</span><span class="token punctuation">,</span> <span class="token string">'none'</span><span class="token punctuation">)</span> <span class="token comment">// 设置响应头部</span>
  <span class="token function">getHtml</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span> <span class="token comment">// 自动设置Content-Type</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      &lt;html&gt;
        &lt;body&gt;
          &lt;h1&gt;hello nest&lt;/hi&gt;
        &lt;/body&gt;
      &lt;/html&gt;
    </span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span>

  @<span class="token function">HttpCode</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span> <span class="token comment">// 设置响应状态码</span>
  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'404'</span><span class="token punctuation">)</span>
  <span class="token function">four0four</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'404 not Found'</span>
  <span class="token punctuation">}</span>

  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'async'</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">testAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>string<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token string">'aa'</span><span class="token punctuation">,</span> <span class="token string">'bb'</span><span class="token punctuation">,</span> <span class="token string">'cc'</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span> 

  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'res'</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">testRes</span><span class="token punctuation">(</span><span class="token parameter">@<span class="token function">Res</span><span class="token punctuation">(</span><span class="token punctuation">)</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'hello nest'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="service"><a href="#service" class="header-anchor">#</a> Service</h5> <p>我们使用<code>Controller</code>来进行路由控制，具体的数据操作或逻辑操作由<code>Service</code>（<code>Service</code>是一种<code>Provider</code>）负责。</p> <p>首先创建<code>Service</code>类，并在<code>app.module.ts</code>中声明该<code>Service</code>为<code>Provider</code>，然后<code>Controller</code>的构造函数添加一个入参（为<code>Service</code>类的实例）。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// app.service.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppService</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> name<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">'akara'</span>

  <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name
  <span class="token punctuation">}</span>

  <span class="token function">setName</span><span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// app.controller.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Controller<span class="token punctuation">,</span> Get<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AppService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app.service'</span><span class="token punctuation">;</span>

@<span class="token function">Controller</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppController</span> <span class="token punctuation">{</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">readonly</span> appService<span class="token operator">:</span> AppService<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/get/service'</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">testGetService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>appService<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  @<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">'/set/service'</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">testSetService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>appService<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">'bkb'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/messiahhh/blog/edit/master/docs/frontend/node.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新时间:</span> <span class="time">7/7/2021, 3:07:14 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/frontend/javascript.html" class="prev">
        JavaScript
      </a></span> <span class="next"><a href="/blog/frontend/stream.html">
        流与二进制
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.8456fffd.js" defer></script><script src="/blog/assets/js/2.8618d6ad.js" defer></script><script src="/blog/assets/js/30.ab15011f.js" defer></script>
  </body>
</html>
